
<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
</head><body>

    <div class="entry">
<center><h1>scrapy学习笔记</h1></center>
<div class="copyright-area">原文出处： <a href="https://segmentfault.com/a/1190000007073049" target="_blank">bomo</a>   </div><p>scrapy是python最有名的爬虫框架之一，可以很方便的进行web抓取，并且提供了很强的定制型，这里记录简单学习的过程和在实际应用中会遇到的一些常见问题</p>
<div>
<h2>一、安装</h2>
<p>在安装scrapy之前有一些依赖需要安装，否则可能会安装失败，scrapy的选择器依赖于<code>lxml</code>，还有<code>Twisted</code>网络引擎，下面是ubuntu下安装的过程</p>
<h3>1. linux下安装</h3>
<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f50f470968601" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
# 1. 安装xml依赖库
$ sudo apt-get install libxml2 libxml2-dev
$ sudo apt-get install libxslt1-dev
$ sudo apt-get install python-libxml2

# 2. 安装lxml
$ sudo pip install lxml

# 3. 安装Twisted（版本可以换成最新的），用pip也可以，如果失败的话下载源码安装，如下
$ wget https://pypi.python.org/packages/6b/23/8dbe86fc83215015e221fbd861a545c6ec5c9e9cd7514af114d1f64084ab/Twisted-16.4.1.tar.bz2#md5=c6d09bdd681f538369659111f079c29d
$ tar xjf Twisted-16.4.1.tar.bz2
$ cd Twisted-16.4.1
$ sudo python setup.py install

# 3. 安装scrapy
$ sudo pip install scrapy</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f50f470968601-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f50f470968601-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f50f470968601-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f50f470968601-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f50f470968601-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f50f470968601-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f50f470968601-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f50f470968601-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f50f470968601-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f50f470968601-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f50f470968601-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f50f470968601-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f50f470968601-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f50f470968601-14">14</div><div class="crayon-num" data-line="crayon-598cd7d19f50f470968601-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f50f470968601-16">16</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f50f470968601-1"><span class="crayon-p"># 1. 安装xml依赖库</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f50f470968601-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">install </span><span class="crayon-e">libxml2 </span><span class="crayon-v">libxml2</span><span class="crayon-o">-</span><span class="crayon-i">dev</span></div><div class="crayon-line" id="crayon-598cd7d19f50f470968601-3"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">install </span><span class="crayon-v">libxslt1</span><span class="crayon-o">-</span><span class="crayon-i">dev</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f50f470968601-4"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">install </span><span class="crayon-v">python</span><span class="crayon-o">-</span><span class="crayon-v">libxml2</span></div><div class="crayon-line" id="crayon-598cd7d19f50f470968601-5"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f50f470968601-6"><span class="crayon-p"># 2. 安装lxml</span></div><div class="crayon-line" id="crayon-598cd7d19f50f470968601-7"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-e">pip </span><span class="crayon-e">install </span><span class="crayon-v">lxml</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f50f470968601-8"> </div><div class="crayon-line" id="crayon-598cd7d19f50f470968601-9"><span class="crayon-p"># 3. 安装Twisted（版本可以换成最新的），用pip也可以，如果失败的话下载源码安装，如下</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f50f470968601-10"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">wget </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-c">//pypi.python.org/packages/6b/23/8dbe86fc83215015e221fbd861a545c6ec5c9e9cd7514af114d1f64084ab/Twisted-16.4.1.tar.bz2#md5=c6d09bdd681f538369659111f079c29d</span></div><div class="crayon-line" id="crayon-598cd7d19f50f470968601-11"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">tar </span><span class="crayon-e">xjf </span><span class="crayon-v">Twisted</span><span class="crayon-o">-</span><span class="crayon-cn">16.4.1.tar.bz2</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f50f470968601-12"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">cd </span><span class="crayon-v">Twisted</span><span class="crayon-o">-</span><span class="crayon-cn">16.4.1</span></div><div class="crayon-line" id="crayon-598cd7d19f50f470968601-13"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-e">python </span><span class="crayon-v">setup</span><span class="crayon-sy">.</span><span class="crayon-e">py </span><span class="crayon-v">install</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f50f470968601-14"> </div><div class="crayon-line" id="crayon-598cd7d19f50f470968601-15"><span class="crayon-p"># 3. 安装scrapy</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f50f470968601-16"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-e">pip </span><span class="crayon-e">install </span><span class="crayon-v">scrapy</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0018 seconds] -->
<p></p>
<blockquote><p><a href="http://lxml.de/installation.html">http://lxml.de/installation.html</a></p></blockquote>
<h3>2. Mac下安装</h3>
<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f518995257428" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
# 安装xml依赖库
$ xcode-select —install

# 其实相关依赖pip会自动帮我们装上
$ pip install scrapy</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f518995257428-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f518995257428-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f518995257428-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f518995257428-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f518995257428-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f518995257428-1"><span class="crayon-p"># 安装xml依赖库</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f518995257428-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">xcode</span><span class="crayon-o">-</span><span class="crayon-i">select</span><span class="crayon-h"> </span>—<span class="crayon-v">install</span></div><div class="crayon-line" id="crayon-598cd7d19f518995257428-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f518995257428-4"><span class="crayon-p"># 其实相关依赖pip会自动帮我们装上</span></div><div class="crayon-line" id="crayon-598cd7d19f518995257428-5"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">pip </span><span class="crayon-e">install </span><span class="crayon-v">scrapy</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>mac下安装有时候会失败，建议使用<code>virtualenv</code>安装在独立的环境下，可以减少一些问题，因为mac系统自带python，例如一些依赖库依赖的一些新的版本，而升级新版本会把旧版本卸载掉，卸载可能会有权限的问题</p>
<h2>二、基本使用</h2>
<h3>1. 初始化scrapy项目</h3>
<p>我们可以使用命令行初始化一个项目</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f51c700253495" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
$ scrapy startproject tutorial</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f51c700253495-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f51c700253495-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">scrapy </span><span class="crayon-e">startproject </span><span class="crayon-v">tutorial</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p></p>
<blockquote><p><a href="https://scrapy-chs.readthedocs.io/zh_CN/0.24/topics/commands.html">这里</a>可以查看scrapy更多其他的命令</p></blockquote>
<p>初始化完成后，我们得到下面目录结构</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f520191693173" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
scrapy.cfg:         项目的配置文件
tutorial/:          该项目的python模块, 在这里添加代码
    items.py:       项目中的item文件
    pipelines.py:   项目中的pipelines文件.
    settings.py:    项目全局设置文件.
    spiders/        爬虫模块目录</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f520191693173-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f520191693173-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f520191693173-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f520191693173-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f520191693173-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f520191693173-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f520191693173-1"><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-v">cfg</span><span class="crayon-o">:</span><span class="crayon-h">         </span>项目的配置文件</div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f520191693173-2"><span class="crayon-v">tutorial</span><span class="crayon-o">/</span><span class="crayon-o">:</span><span class="crayon-h">          </span>该项目的<span class="crayon-i">python</span>模块<span class="crayon-sy">,</span><span class="crayon-h"> </span>在这里添加代码</div><div class="crayon-line" id="crayon-598cd7d19f520191693173-3"><span class="crayon-h">    </span><span class="crayon-v">items</span><span class="crayon-sy">.</span><span class="crayon-v">py</span><span class="crayon-o">:</span><span class="crayon-h">       </span>项目中的<span class="crayon-i">item</span>文件</div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f520191693173-4"><span class="crayon-h">    </span><span class="crayon-v">pipelines</span><span class="crayon-sy">.</span><span class="crayon-v">py</span><span class="crayon-o">:</span><span class="crayon-h">   </span>项目中的<span class="crayon-i">pipelines</span>文件<span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-598cd7d19f520191693173-5"><span class="crayon-h">    </span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-v">py</span><span class="crayon-o">:</span><span class="crayon-h">    </span>项目全局设置文件<span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f520191693173-6"><span class="crayon-h">    </span><span class="crayon-v">spiders</span><span class="crayon-o">/</span><span class="crayon-h">        </span>爬虫模块目录</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>我们先看一下scrapy的处理流程<br/>
<img src="images/a97ff00ebbcb61442c426f9fff33ba24.png"/></p>
<p>scrapy由下面几个部分组成</p>
<ul>
<li><code>spiders</code>：爬虫模块，负责配置需要爬取的数据和爬取规则，以及解析结构化数据</li>
<li><code>items</code>：定义我们需要的结构化数据，使用相当于<code>dict</code></li>
<li><code>pipelines</code>：管道模块，处理spider模块分析好的结构化数据，如保存入库等</li>
<li><code>middlewares</code>：中间件，相当于钩子，可以对爬取前后做预处理，如修改请求header，url过滤等</li>
</ul>
<p>我们先来看一个例子，在<code>spiders</code>目录下新建一个模块<code>DmozSpider.py</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f524692868645" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
import scrapy

class DmozSpider(scrapy.Spider):
    # 必须定义
    name = "dmoz"
    # 初始urls
    start_urls = [
        "http://www.dmoz.org/Computers/Programming/Languages/Python/Books/",
        "http://www.dmoz.org/Computers/Programming/Languages/Python/Resources/"
    ]

    # 默认response处理函数
    def parse(self, response):
        # 把结果写到文件中
        filename = response.url.split("/")[-2]
        with open(filename, 'wb') as f:
            f.write(response.body)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f524692868645-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f524692868645-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f524692868645-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f524692868645-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f524692868645-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f524692868645-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f524692868645-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f524692868645-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f524692868645-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f524692868645-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f524692868645-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f524692868645-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f524692868645-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f524692868645-14">14</div><div class="crayon-num" data-line="crayon-598cd7d19f524692868645-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f524692868645-16">16</div><div class="crayon-num" data-line="crayon-598cd7d19f524692868645-17">17</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f524692868645-1"><span class="crayon-e">import </span><span class="crayon-e">scrapy</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f524692868645-2"> </div><div class="crayon-line" id="crayon-598cd7d19f524692868645-3"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">DmozSpider</span><span class="crayon-sy">(</span><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-v">Spider</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f524692868645-4"><span class="crayon-h">    </span><span class="crayon-p"># 必须定义</span></div><div class="crayon-line" id="crayon-598cd7d19f524692868645-5"><span class="crayon-h">    </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"dmoz"</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f524692868645-6"><span class="crayon-h">    </span><span class="crayon-p"># 初始urls</span></div><div class="crayon-line" id="crayon-598cd7d19f524692868645-7"><span class="crayon-h">    </span><span class="crayon-v">start_urls</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f524692868645-8"><span class="crayon-h">        </span><span class="crayon-s">"http://www.dmoz.org/Computers/Programming/Languages/Python/Books/"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f524692868645-9"><span class="crayon-h">        </span><span class="crayon-s">"http://www.dmoz.org/Computers/Programming/Languages/Python/Resources/"</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f524692868645-10"><span class="crayon-h">    </span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-598cd7d19f524692868645-11"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f524692868645-12"><span class="crayon-h">    </span><span class="crayon-p"># 默认response处理函数</span></div><div class="crayon-line" id="crayon-598cd7d19f524692868645-13"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f524692868645-14"><span class="crayon-h">        </span><span class="crayon-p"># 把结果写到文件中</span></div><div class="crayon-line" id="crayon-598cd7d19f524692868645-15"><span class="crayon-h">        </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">url</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">"/"</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f524692868645-16"><span class="crayon-h">        </span><span class="crayon-e">with </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wb'</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-v">f</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f524692868645-17"><span class="crayon-h">            </span><span class="crayon-v">f</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">body</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0020 seconds] -->
<p>打开终端进入根目录，执行下面命令</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f527864433509" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
$ scrapy crawl dmoz</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f527864433509-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f527864433509-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">scrapy </span><span class="crayon-e">crawl </span><span class="crayon-v">dmoz</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>爬虫开始爬取start_urls定义的url，并输出到文件中，最后输出爬去报告，会输出爬取得统计结果</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f52a623508723" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div><span class="crayon-language">Python</span></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
2016-09-13 10:36:43 [scrapy] INFO: Spider opened
2016-09-13 10:36:43 [scrapy] INFO: Crawled 0 pages (at 0 pages/min), scraped 0 items (at 0 items/min)
2016-09-13 10:36:43 [scrapy] DEBUG: Telnet console listening on 127.0.0.1:6023
2016-09-13 10:36:44 [scrapy] DEBUG: Crawled (200) &lt;GET http://www.dmoz.org/Computers/Programming/Languages/Python/Resources/&gt; (referer: None)
2016-09-13 10:36:45 [scrapy] DEBUG: Crawled (200) &lt;GET http://www.dmoz.org/Computers/Programming/Languages/Python/Books/&gt; (referer: None)
2016-09-13 10:36:45 [scrapy] INFO: Closing spider (finished)
2016-09-13 10:36:45 [scrapy] INFO: Dumping Scrapy stats:
{'downloader/request_bytes': 548,
 'downloader/request_count': 2,
 'downloader/request_method_count/GET': 2,
 'downloader/response_bytes': 16179,
 'downloader/response_count': 2,
 'downloader/response_status_count/200': 2,
 'finish_reason': 'finished',
 'finish_time': datetime.datetime(2016, 9, 13, 2, 36, 45, 585113),
 'log_count/DEBUG': 3,
 'log_count/INFO': 7,
 'response_received_count': 2,
 'scheduler/dequeued': 2,
 'scheduler/dequeued/memory': 2,
 'scheduler/enqueued': 2,
 'scheduler/enqueued/memory': 2,
 'start_time': datetime.datetime(2016, 9, 13, 2, 36, 43, 935790)}
2016-09-13 10:36:45 [scrapy] INFO: Spider closed (finished)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-14">14</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-16">16</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-18">18</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-20">20</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-22">22</div><div class="crayon-num" data-line="crayon-598cd7d19f52a623508723-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52a623508723-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f52a623508723-1"><span class="crayon-cn">2016</span><span class="crayon-o">-</span><span class="crayon-cn">09</span><span class="crayon-o">-</span><span class="crayon-cn">13</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">36</span><span class="crayon-o">:</span><span class="crayon-cn">43</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">scrapy</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">INFO</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Spider </span><span class="crayon-i">opened</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-2"><span class="crayon-cn">2016</span><span class="crayon-o">-</span><span class="crayon-cn">09</span><span class="crayon-o">-</span><span class="crayon-cn">13</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">36</span><span class="crayon-o">:</span><span class="crayon-cn">43</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">scrapy</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">INFO</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">Crawled</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">pages</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">at</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-v">pages</span><span class="crayon-o">/</span><span class="crayon-k ">min</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">scraped</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">items</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">at</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-v">items</span><span class="crayon-o">/</span><span class="crayon-k ">min</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-3"><span class="crayon-cn">2016</span><span class="crayon-o">-</span><span class="crayon-cn">09</span><span class="crayon-o">-</span><span class="crayon-cn">13</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">36</span><span class="crayon-o">:</span><span class="crayon-cn">43</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">scrapy</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">DEBUG</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Telnet </span><span class="crayon-e">console </span><span class="crayon-e">listening </span><span class="crayon-i">on</span><span class="crayon-h"> </span><span class="crayon-cn">127.0.0.1</span><span class="crayon-o">:</span><span class="crayon-cn">6023</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-4"><span class="crayon-cn">2016</span><span class="crayon-o">-</span><span class="crayon-cn">09</span><span class="crayon-o">-</span><span class="crayon-cn">13</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">36</span><span class="crayon-o">:</span><span class="crayon-cn">44</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">scrapy</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">DEBUG</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Crawled</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">GET </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">www</span><span class="crayon-sy">.</span><span class="crayon-v">dmoz</span><span class="crayon-sy">.</span><span class="crayon-v">org</span><span class="crayon-o">/</span><span class="crayon-v">Computers</span><span class="crayon-o">/</span><span class="crayon-v">Programming</span><span class="crayon-o">/</span><span class="crayon-v">Languages</span><span class="crayon-o">/</span><span class="crayon-v">Python</span><span class="crayon-o">/</span><span class="crayon-v">Resources</span><span class="crayon-o">/</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">referer</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-5"><span class="crayon-cn">2016</span><span class="crayon-o">-</span><span class="crayon-cn">09</span><span class="crayon-o">-</span><span class="crayon-cn">13</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">36</span><span class="crayon-o">:</span><span class="crayon-cn">45</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">scrapy</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">DEBUG</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Crawled</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">200</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-e">GET </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-o">/</span><span class="crayon-o">/</span><span class="crayon-v">www</span><span class="crayon-sy">.</span><span class="crayon-v">dmoz</span><span class="crayon-sy">.</span><span class="crayon-v">org</span><span class="crayon-o">/</span><span class="crayon-v">Computers</span><span class="crayon-o">/</span><span class="crayon-v">Programming</span><span class="crayon-o">/</span><span class="crayon-v">Languages</span><span class="crayon-o">/</span><span class="crayon-v">Python</span><span class="crayon-o">/</span><span class="crayon-v">Books</span><span class="crayon-o">/</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">referer</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">None</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-6"><span class="crayon-cn">2016</span><span class="crayon-o">-</span><span class="crayon-cn">09</span><span class="crayon-o">-</span><span class="crayon-cn">13</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">36</span><span class="crayon-o">:</span><span class="crayon-cn">45</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">scrapy</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">INFO</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Closing </span><span class="crayon-e">spider</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">finished</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-7"><span class="crayon-cn">2016</span><span class="crayon-o">-</span><span class="crayon-cn">09</span><span class="crayon-o">-</span><span class="crayon-cn">13</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">36</span><span class="crayon-o">:</span><span class="crayon-cn">45</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">scrapy</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">INFO</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Dumping </span><span class="crayon-e">Scrapy </span><span class="crayon-v">stats</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-8"><span class="crayon-sy">{</span><span class="crayon-s">'downloader/request_bytes'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">548</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-9"><span class="crayon-h"> </span><span class="crayon-s">'downloader/request_count'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-10"><span class="crayon-h"> </span><span class="crayon-s">'downloader/request_method_count/GET'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-11"><span class="crayon-h"> </span><span class="crayon-s">'downloader/response_bytes'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">16179</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-12"><span class="crayon-h"> </span><span class="crayon-s">'downloader/response_count'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-13"><span class="crayon-h"> </span><span class="crayon-s">'downloader/response_status_count/200'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-14"><span class="crayon-h"> </span><span class="crayon-s">'finish_reason'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'finished'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-15"><span class="crayon-h"> </span><span class="crayon-s">'finish_time'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-k ">datetime</span><span class="crayon-sy">.</span><span class="crayon-k ">datetime</span><span class="crayon-sy">(</span><span class="crayon-cn">2016</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">9</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">13</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">36</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">45</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">585113</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-16"><span class="crayon-h"> </span><span class="crayon-s">'log_count/DEBUG'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-17"><span class="crayon-h"> </span><span class="crayon-s">'log_count/INFO'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-18"><span class="crayon-h"> </span><span class="crayon-s">'response_received_count'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-19"><span class="crayon-h"> </span><span class="crayon-s">'scheduler/dequeued'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-20"><span class="crayon-h"> </span><span class="crayon-s">'scheduler/dequeued/memory'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-21"><span class="crayon-h"> </span><span class="crayon-s">'scheduler/enqueued'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-22"><span class="crayon-h"> </span><span class="crayon-s">'scheduler/enqueued/memory'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f52a623508723-23"><span class="crayon-h"> </span><span class="crayon-s">'start_time'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-k ">datetime</span><span class="crayon-sy">.</span><span class="crayon-k ">datetime</span><span class="crayon-sy">(</span><span class="crayon-cn">2016</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">9</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">13</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">36</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">43</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">935790</span><span class="crayon-sy">)</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52a623508723-24"><span class="crayon-cn">2016</span><span class="crayon-o">-</span><span class="crayon-cn">09</span><span class="crayon-o">-</span><span class="crayon-cn">13</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-o">:</span><span class="crayon-cn">36</span><span class="crayon-o">:</span><span class="crayon-cn">45</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">scrapy</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">INFO</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">Spider </span><span class="crayon-e">closed</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">finished</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0104 seconds] -->
<p>这里我们完成了简单的爬取和保存的操作，会在根目录生成两个文件<code>Resources</code>和<code>Books</code></p>
<h3>2. 通过代码运行爬虫</h3>
<p>每次进入控制台运行爬虫还是比较麻烦的，而且不好调试，我们可以通过<code>CrawlerProcess</code>通过代码运行爬虫，新建一个模块<code>run.py</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f52f153520960" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
from scrapy.crawler import CrawlerProcess
from scrapy.utils.project import get_project_settings

from spiders.DmozSpider import DmozSpider

# 获取settings.py模块的设置
settings = get_project_settings()
process = CrawlerProcess(settings=settings)

# 可以添加多个spider
# process.crawl(Spider1)
# process.crawl(Spider2)
process.crawl(DmozSpider)

# 启动爬虫，会阻塞，直到爬取完成
process.start()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f52f153520960-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52f153520960-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f52f153520960-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52f153520960-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f52f153520960-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52f153520960-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f52f153520960-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52f153520960-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f52f153520960-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52f153520960-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f52f153520960-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52f153520960-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f52f153520960-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52f153520960-14">14</div><div class="crayon-num" data-line="crayon-598cd7d19f52f153520960-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f52f153520960-16">16</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f52f153520960-1"><span class="crayon-e">from </span><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-e">crawler </span><span class="crayon-e">import </span><span class="crayon-e">CrawlerProcess</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52f153520960-2"><span class="crayon-e">from </span><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-v">utils</span><span class="crayon-sy">.</span><span class="crayon-e">project </span><span class="crayon-e">import </span><span class="crayon-e">get_project_settings</span></div><div class="crayon-line" id="crayon-598cd7d19f52f153520960-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52f153520960-4"><span class="crayon-e">from </span><span class="crayon-v">spiders</span><span class="crayon-sy">.</span><span class="crayon-e">DmozSpider </span><span class="crayon-e">import </span><span class="crayon-v">DmozSpider</span></div><div class="crayon-line" id="crayon-598cd7d19f52f153520960-5"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52f153520960-6"><span class="crayon-p"># 获取settings.py模块的设置</span></div><div class="crayon-line" id="crayon-598cd7d19f52f153520960-7"><span class="crayon-v">settings</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_project_settings</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52f153520960-8"><span class="crayon-v">process</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">CrawlerProcess</span><span class="crayon-sy">(</span><span class="crayon-v">settings</span><span class="crayon-o">=</span><span class="crayon-v">settings</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f52f153520960-9"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52f153520960-10"><span class="crayon-p"># 可以添加多个spider</span></div><div class="crayon-line" id="crayon-598cd7d19f52f153520960-11"><span class="crayon-p"># process.crawl(Spider1)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52f153520960-12"><span class="crayon-p"># process.crawl(Spider2)</span></div><div class="crayon-line" id="crayon-598cd7d19f52f153520960-13"><span class="crayon-v">process</span><span class="crayon-sy">.</span><span class="crayon-e">crawl</span><span class="crayon-sy">(</span><span class="crayon-v">DmozSpider</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52f153520960-14"> </div><div class="crayon-line" id="crayon-598cd7d19f52f153520960-15"><span class="crayon-p"># 启动爬虫，会阻塞，直到爬取完成</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f52f153520960-16"><span class="crayon-v">process</span><span class="crayon-sy">.</span><span class="crayon-e">start</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0014 seconds] -->
<p></p>
<blockquote><p>参考：<a href="http://doc.scrapy.org/en/latest/topics/practices.html#run-scrapy-from-a-script">http://doc.scrapy.org/en/latest/topics/practices.html#run-scrapy-from-a-script</a></p></blockquote>
<h2>三、Scrapy类</h2>
<p>如上面的<code>DmozSpider</code>类，爬虫类继承自<code>scrapy.Spider</code>，用于构造<code>Request</code>对象给Scheduler</p>
<h3>1. 常用属性与方法</h3>
<p><em>属性</em></p>
<ul>
<li><code>name</code>：爬虫的名字，必须唯一（如果在控制台使用的话，必须配置）</li>
<li><code>start_urls</code>：爬虫初始爬取的链接列表</li>
<li><code>parse</code>：response结果处理函数</li>
<li><code>custom_settings</code>：自定义配置，覆盖<code>settings.py</code>中的默认配置</li>
</ul>
<p><em>方法</em></p>
<ul>
<li><code>start_requests</code>：启动爬虫的时候调用，默认是调用<code>make_requests_from_url</code>方法爬取<code>start_urls</code>的链接，可以在这个方法里面定制，如果重写了该方法，start_urls默认将不会被使用，可以在这个方法里面定制一些自定义的url，如登录，从数据库读取url等，本方法返回Request对象</li>
<li><code>make_requests_from_url</code>：默认由<code>start_requests</code>调用，可以配置Request对象，返回Request对象</li>
<li><code>parse</code>：response到达spider的时候默认调用，如果在Request对象配置了callback函数，则不会调用，parse方法可以迭代返回<code>Item</code>或<code>Request</code>对象，如果返回Request对象，则会进行增量爬取</li>
</ul>
<h3>2. Request与Response对象</h3>
<p>每个请求都是一个Request对象，Request对象定义了请求的相关信息（<code>url</code>, <code>method</code>, <code>headers</code>, <code>body</code>, <code>cookie</code>, <code>priority</code>）和回调的相关信息（<code>meta</code>, <code>callback</code>, <code>dont_filter</code>, <code>errback</code>），通常由spider迭代返回</p>
<p>其中<code>meta</code>相当于附加变量，可以在请求完成后通过<code>response.meta</code>访问</p>
<p>请求完成后，会通过<code>Response</code>对象发送给spider处理，常用属性有（<code>url</code>, <code>status</code>, <code>headers</code>, <code>body</code>, <code>request</code>, <code>meta</code>, ）</p>
<p>详细介绍参考官网</p>
<ul>
<li><a href="https://doc.scrapy.org/en/latest/topics/request-response.html#request-objects">https://doc.scrapy.org/en/latest/topics/request-response.html#request-objects</a></li>
<li><a href="https://doc.scrapy.org/en/latest/topics/request-response.html#response-objects">https://doc.scrapy.org/en/latest/topics/request-response.html#response-objects</a></li>
</ul>
<p>看下面这个例子</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f534099989756" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
from scrapy import Spider
from scrapy import Request

class TestSpider(Spider):
    name = 'test'
    start_urls = [
        "http://www.qq.com/",
    ]

    def login_parse(self, response):
        ''' 如果登录成功,手动构造请求Request迭代返回 '''
        print response
        for i in range(0, 10):
            yield Request('http://www.example.com/list/1?page={0}'.format(i))

    def start_requests(self):
        ''' 覆盖默认的方法(忽略start_urls),返回登录请求页,制定处理函数为login_parse '''
        return Request('http://www.example.com/login', method="POST" body='username=bomo&amp;pwd=123456', callback=self.login_parse)


    def parse(self, response):
        ''' 默认请求处理函数 '''
        print response</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-14">14</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-16">16</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-18">18</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-20">20</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f534099989756-22">22</div><div class="crayon-num" data-line="crayon-598cd7d19f534099989756-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f534099989756-1"><span class="crayon-e">from </span><span class="crayon-e">scrapy </span><span class="crayon-e">import </span><span class="crayon-e">Spider</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-2"><span class="crayon-e">from </span><span class="crayon-e">scrapy </span><span class="crayon-e">import </span><span class="crayon-e">Request</span></div><div class="crayon-line" id="crayon-598cd7d19f534099989756-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-4"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">TestSpider</span><span class="crayon-sy">(</span><span class="crayon-v">Spider</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f534099989756-5"><span class="crayon-h">    </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'test'</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-6"><span class="crayon-h">    </span><span class="crayon-v">start_urls</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line" id="crayon-598cd7d19f534099989756-7"><span class="crayon-h">        </span><span class="crayon-s">"http://www.qq.com/"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-8"><span class="crayon-h">    </span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-598cd7d19f534099989756-9"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-10"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">login_parse</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f534099989756-11"><span class="crayon-h">        </span><span class="crayon-s">''</span><span class="crayon-s">' 如果登录成功,手动构造请求Request迭代返回 '</span><span class="crayon-s">''</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-12"><span class="crayon-h">        </span><span class="crayon-e">print </span><span class="crayon-e">response</span></div><div class="crayon-line" id="crayon-598cd7d19f534099989756-13"><span class="crayon-e">        </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-14"><span class="crayon-h">            </span><span class="crayon-e">yield </span><span class="crayon-e">Request</span><span class="crayon-sy">(</span><span class="crayon-s">'http://www.example.com/list/1?page={0}'</span><span class="crayon-sy">.</span><span class="crayon-e">format</span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f534099989756-15"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-16"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">start_requests</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f534099989756-17"><span class="crayon-h">        </span><span class="crayon-s">''</span><span class="crayon-s">' 覆盖默认的方法(忽略start_urls),返回登录请求页,制定处理函数为login_parse '</span><span class="crayon-s">''</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-18"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">Request</span><span class="crayon-sy">(</span><span class="crayon-s">'http://www.example.com/login'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">method</span><span class="crayon-o">=</span><span class="crayon-s">"POST"</span><span class="crayon-h"> </span><span class="crayon-v">body</span><span class="crayon-o">=</span><span class="crayon-s">'username=bomo&amp;pwd=123456'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">callback</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">login_parse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f534099989756-19"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-20"> </div><div class="crayon-line" id="crayon-598cd7d19f534099989756-21"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f534099989756-22"><span class="crayon-h">        </span><span class="crayon-s">''</span><span class="crayon-s">' 默认请求处理函数 '</span><span class="crayon-s">''</span></div><div class="crayon-line" id="crayon-598cd7d19f534099989756-23"><span class="crayon-h">        </span><span class="crayon-e">print </span><span class="crayon-v">response</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0028 seconds] -->
<p></p>
<h2>四、Selector</h2>
<p>上面我们只是爬取了网页的html文本，对于爬虫，我们需要明确我们需要爬取的结构化数据，需要对原文本进行解析，解析的方法通常有下面这些</p>
<ul>
<li>普通文本操作</li>
<li>正则表达式：<code>re</code></li>
<li>Dom树操作：<code>BeautifulSoup</code></li>
<li>XPath选择器：<code>lxml</code></li>
</ul>
<p>scrapy默认支持选择器的功能，自带的选择器构建与lxml之上，并对其进行了改进，使用起来更为简洁明了</p>
<h3>1. XPath选择器</h3>
<p>XPpath是标准的XML文档查询语言，可以用于查询XML文档中的节点和内容，关于XPath语法，可以参见<a href="http://www.w3school.com.cn/xpath/">这里</a></p>
<p>先看一个例子，通过html或xml构造Selector对象，然后通过xpath查询节点，并解析出节点的内容</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f539502424151" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div><span class="crayon-language">Python</span></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
from scrapy import Selector

html = '&lt;html&gt;&lt;body&gt;&lt;span&gt;good&lt;/span&gt;&lt;span&gt;buy&lt;/span&gt;&lt;/body&gt;&lt;/html&gt;'
sel = Selector(text=html)
nodes = sel.xpath('//span')
for node in nodes:
    print node.extract()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f539502424151-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f539502424151-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f539502424151-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f539502424151-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f539502424151-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f539502424151-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f539502424151-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f539502424151-1"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-e">scrapy </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">Selector</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f539502424151-2"> </div><div class="crayon-line" id="crayon-598cd7d19f539502424151-3"><span class="crayon-v">html</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'&lt;html&gt;&lt;body&gt;&lt;span&gt;good&lt;/span&gt;&lt;span&gt;buy&lt;/span&gt;&lt;/body&gt;&lt;/html&gt;'</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f539502424151-4"><span class="crayon-v">sel</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Selector</span><span class="crayon-sy">(</span><span class="crayon-v">text</span><span class="crayon-o">=</span><span class="crayon-v">html</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f539502424151-5"><span class="crayon-v">nodes</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sel</span><span class="crayon-sy">.</span><span class="crayon-e">xpath</span><span class="crayon-sy">(</span><span class="crayon-s">'//span'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f539502424151-6"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">node </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">nodes</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f539502424151-7"><span class="crayon-h">    </span><span class="crayon-k ">print</span><span class="crayon-h"> </span><span class="crayon-v">node</span><span class="crayon-sy">.</span><span class="crayon-e">extract</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>Selector相当于节点，通过xpath去到子节点集合（SelectorList），可以继续搜索，通过<code>extract</code>方法可以取出节点的值，<code>extract</code>方法也可以作用于SelectorList，对于SelectorList可以通过<code>extract_first</code>取出第一个节点的值</p>
<ul>
<li>通过<code>text()</code>取出节点的内容</li>
<li>通过<code>@href</code>去除节点属性值（这里是取出<code>href</code>属性的值）</li>
<li>直接对节点取值，则是输出节点的字符串</li>
</ul>
<h3>2. CSS选择器</h3>
<p>除了XPath选择器，scrapy还支持css选择器</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f53c714344857" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div><span class="crayon-language">Python</span></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
html = """
        &lt;html&gt;
            &lt;body&gt;
                &lt;span&gt;good&lt;/span&gt;
                &lt;span&gt;buy&lt;/span&gt;
                &lt;ul&gt;
                    &lt;li class="video_part_lists"&gt;aa&lt;li&gt;
                    &lt;li class="video_part_lists"&gt;bb&lt;li&gt;
                    &lt;li class="audio_part_lists"&gt;cc&lt;li&gt;
                    &lt;li class="video_part_lists"&gt;
                        &lt;a href="/"&gt;主页&lt;/a&gt;
                    &lt;li&gt;
                &lt;/ul&gt;
            &lt;/body&gt;
        &lt;/html&gt;
        """
sel = Selector(text=html)

# 选择class为video_part_lists的li节点
lis = sel.css('li.video_part_lists')

for li in lis:
    # 选择a节点的属性
    print li.css('a::attr(href)').extract()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-14">14</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-16">16</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-18">18</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-20">20</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-22">22</div><div class="crayon-num" data-line="crayon-598cd7d19f53c714344857-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f53c714344857-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f53c714344857-1"><span class="crayon-v">html</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"""</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-2"><span class="crayon-s">        &lt;html&gt;</span></div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-3"><span class="crayon-s">            &lt;body&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-4"><span class="crayon-s">                &lt;span&gt;good&lt;/span&gt;</span></div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-5"><span class="crayon-s">                &lt;span&gt;buy&lt;/span&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-6"><span class="crayon-s">                &lt;ul&gt;</span></div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-7"><span class="crayon-s">                    &lt;li class="video_part_lists"&gt;aa&lt;li&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-8"><span class="crayon-s">                    &lt;li class="video_part_lists"&gt;bb&lt;li&gt;</span></div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-9"><span class="crayon-s">                    &lt;li class="audio_part_lists"&gt;cc&lt;li&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-10"><span class="crayon-s">                    &lt;li class="video_part_lists"&gt;</span></div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-11"><span class="crayon-s">                        &lt;a href="/"&gt;主页&lt;/a&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-12"><span class="crayon-s">                    &lt;li&gt;</span></div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-13"><span class="crayon-s">                &lt;/ul&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-14"><span class="crayon-s">            &lt;/body&gt;</span></div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-15"><span class="crayon-s">        &lt;/html&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-16"><span class="crayon-s">        """</span></div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-17"><span class="crayon-v">sel</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Selector</span><span class="crayon-sy">(</span><span class="crayon-v">text</span><span class="crayon-o">=</span><span class="crayon-v">html</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-18"> </div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-19"><span class="crayon-c"># 选择class为video_part_lists的li节点</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-20"><span class="crayon-v">lis</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sel</span><span class="crayon-sy">.</span><span class="crayon-e">css</span><span class="crayon-sy">(</span><span class="crayon-s">'li.video_part_lists'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-21"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-22"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">li </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">lis</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f53c714344857-23"><span class="crayon-h">    </span><span class="crayon-c"># 选择a节点的属性</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f53c714344857-24"><span class="crayon-h">    </span><span class="crayon-k ">print</span><span class="crayon-h"> </span><span class="crayon-v">li</span><span class="crayon-sy">.</span><span class="crayon-e">css</span><span class="crayon-sy">(</span><span class="crayon-s">'a::attr(href)'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">extract</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0020 seconds] -->
<p>关于css选择器更多的规则，可以见w3c官网</p>
<ul>
<li><a href="https://www.w3.org/TR/selectors/">https://www.w3.org/TR/selectors/</a></li>
</ul>
<h2>五、Item类</h2>
<p>上面我们只是爬取了网页的html文本，对于爬虫，我们需要明确我们需要爬取的结构化数据，我们定义一个item存储分类信息，scrapy的item继承自<code>scrapy.Item</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f540455827498" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
from scrapy import Item, Field

class DmozItem(Item):
    title = Field()
    link = Field()
    desc = Field()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f540455827498-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f540455827498-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f540455827498-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f540455827498-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f540455827498-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f540455827498-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f540455827498-1"><span class="crayon-e">from </span><span class="crayon-e">scrapy </span><span class="crayon-e">import </span><span class="crayon-v">Item</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">Field</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f540455827498-2"> </div><div class="crayon-line" id="crayon-598cd7d19f540455827498-3"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">DmozItem</span><span class="crayon-sy">(</span><span class="crayon-v">Item</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f540455827498-4"><span class="crayon-h">    </span><span class="crayon-v">title</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Field</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f540455827498-5"><span class="crayon-h">    </span><span class="crayon-v">link</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Field</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f540455827498-6"><span class="crayon-h">    </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Field</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0011 seconds] -->
<p><code>scrapy.Item</code>的用法与python中的字典用法基本一样，只是做了一些安全限制，属性定义使用Field，这里只是进行了声明，而不是真正的属性，使用的时候通过键值对操作，<strong>不支持属性访问</strong></p>
<p>what, 好坑爹，这意味着所有的属性赋值都得用字符串了，这里有解释（还是没太明白）</p>
<blockquote>
<ul>
<li><a href="http://stackoverflow.com/questions/14899815/why-is-scrapys-field-a-dict">why-is-scrapys-field-a-dict</a></li>
</ul>
</blockquote>
<p>修改DmozSpider的parse方法</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f543423960580" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
class DmozSpider(scrapy.Spider):
    ...
    def parse(self, response):
        for sel in response.xpath('//ul/li'):
            dmoz_item = DmozItem()
            dmoz_item['title'] = sel.xpath('a/text()').extract()
            dmoz_item['link'] = sel.xpath('a/@href').extract()
            dmoz_item['desc'] = sel.xpath('text()').extract()
            print dmoz_item</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f543423960580-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f543423960580-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f543423960580-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f543423960580-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f543423960580-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f543423960580-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f543423960580-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f543423960580-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f543423960580-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f543423960580-1"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">DmozSpider</span><span class="crayon-sy">(</span><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-v">Spider</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f543423960580-2"><span class="crayon-h">    </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-598cd7d19f543423960580-3"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f543423960580-4"><span class="crayon-h">        </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">sel </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-e">xpath</span><span class="crayon-sy">(</span><span class="crayon-s">'//ul/li'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f543423960580-5"><span class="crayon-h">            </span><span class="crayon-v">dmoz_item</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DmozItem</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f543423960580-6"><span class="crayon-h">            </span><span class="crayon-v">dmoz_item</span><span class="crayon-sy">[</span><span class="crayon-s">'title'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sel</span><span class="crayon-sy">.</span><span class="crayon-e">xpath</span><span class="crayon-sy">(</span><span class="crayon-s">'a/text()'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">extract</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f543423960580-7"><span class="crayon-h">            </span><span class="crayon-v">dmoz_item</span><span class="crayon-sy">[</span><span class="crayon-s">'link'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sel</span><span class="crayon-sy">.</span><span class="crayon-e">xpath</span><span class="crayon-sy">(</span><span class="crayon-s">'a/@href'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">extract</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f543423960580-8"><span class="crayon-h">            </span><span class="crayon-v">dmoz_item</span><span class="crayon-sy">[</span><span class="crayon-s">'desc'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sel</span><span class="crayon-sy">.</span><span class="crayon-e">xpath</span><span class="crayon-sy">(</span><span class="crayon-s">'text()'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">extract</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f543423960580-9"><span class="crayon-h">            </span><span class="crayon-e">print </span><span class="crayon-v">dmoz_item</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0022 seconds] -->
<p></p>
<h2>六、Pipeline</h2>
<p>spider负责爬虫的配置，item负责声明结构化数据，而对于数据的处理，在scrapy中使用管道的方式进行处理，只要注册过的管道都可以处理item数据（处理，过滤，保存）</p>
<p>下面看看管道的声明方式，这里定义一个预处理管道<code>PretreatmentPipeline.py</code>，如果item的title为None，则设置为空字符串</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f547682854926" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
class PretreatmentPipeline(object):
    def process_item(self, item, spider):
        if item['title']:
            # 不让title为空
            item['title'] = ''
        return item</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f547682854926-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f547682854926-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f547682854926-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f547682854926-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f547682854926-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f547682854926-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f547682854926-1"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">PretreatmentPipeline</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f547682854926-2"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">process_item</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">item</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">spider</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f547682854926-3"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">item</span><span class="crayon-sy">[</span><span class="crayon-s">'title'</span><span class="crayon-sy">]</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f547682854926-4"><span class="crayon-h">            </span><span class="crayon-p"># 不让title为空</span></div><div class="crayon-line" id="crayon-598cd7d19f547682854926-5"><span class="crayon-h">            </span><span class="crayon-v">item</span><span class="crayon-sy">[</span><span class="crayon-s">'title'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">''</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f547682854926-6"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">item</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0011 seconds] -->
<p>再定义一个过滤重复数据的管道<code>DuplicatesPipeline.py</code>，当link重复，则丢弃</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f54b544706853" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
from scrapy.exceptions import DropItem

class DuplicatesPipeline(object):
    def __init__(self):
        self.links = set()

    def process_item(self, item, spider):
        if item['link'] in self.links:
            # 跑出DropItem表示丢掉数据
            raise DropItem("Duplicate item found: %s" % item)
        else:
            self.links.add(item['link'])
            return item</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f54b544706853-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54b544706853-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f54b544706853-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54b544706853-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f54b544706853-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54b544706853-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f54b544706853-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54b544706853-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f54b544706853-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54b544706853-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f54b544706853-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54b544706853-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f54b544706853-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f54b544706853-1"><span class="crayon-e">from </span><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-e">exceptions </span><span class="crayon-e">import </span><span class="crayon-e">DropItem</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54b544706853-2"> </div><div class="crayon-line" id="crayon-598cd7d19f54b544706853-3"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">DuplicatesPipeline</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54b544706853-4"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f54b544706853-5"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">links</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54b544706853-6"> </div><div class="crayon-line" id="crayon-598cd7d19f54b544706853-7"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">process_item</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">item</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">spider</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54b544706853-8"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">item</span><span class="crayon-sy">[</span><span class="crayon-s">'link'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">links</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f54b544706853-9"><span class="crayon-h">            </span><span class="crayon-p"># 跑出DropItem表示丢掉数据</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54b544706853-10"><span class="crayon-h">            </span><span class="crayon-e">raise </span><span class="crayon-e">DropItem</span><span class="crayon-sy">(</span><span class="crayon-s">"Duplicate item found: %s"</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">item</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f54b544706853-11"><span class="crayon-h">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54b544706853-12"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">links</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">item</span><span class="crayon-sy">[</span><span class="crayon-s">'link'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f54b544706853-13"><span class="crayon-h">            </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">item</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0020 seconds] -->
<p>最后可以定义一个保存数据的管道，可以把数据保存到数据库中</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f54e069714652" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
from scrapy.exceptions import DropItem
from Database import Database

class DatabasePipeline(object):
    def __init__(self):
        self.db = Database

    def process_item(self, item, spider):
        if self.db.item_exists(item['id']):
            self.db.update_item(item)
        else:
            self.db.insert_item(item)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f54e069714652-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54e069714652-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f54e069714652-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54e069714652-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f54e069714652-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54e069714652-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f54e069714652-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54e069714652-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f54e069714652-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54e069714652-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f54e069714652-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f54e069714652-12">12</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f54e069714652-1"><span class="crayon-e">from </span><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-e">exceptions </span><span class="crayon-e">import </span><span class="crayon-e">DropItem</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54e069714652-2"><span class="crayon-e">from </span><span class="crayon-e">Database </span><span class="crayon-e">import </span><span class="crayon-e">Database</span></div><div class="crayon-line" id="crayon-598cd7d19f54e069714652-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54e069714652-4"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">DatabasePipeline</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f54e069714652-5"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54e069714652-6"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">db</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Database</span></div><div class="crayon-line" id="crayon-598cd7d19f54e069714652-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54e069714652-8"><span class="crayon-e">    </span><span class="crayon-e">def </span><span class="crayon-e">process_item</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">item</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">spider</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f54e069714652-9"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-e">item_exists</span><span class="crayon-sy">(</span><span class="crayon-v">item</span><span class="crayon-sy">[</span><span class="crayon-s">'id'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54e069714652-10"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-e">update_item</span><span class="crayon-sy">(</span><span class="crayon-v">item</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f54e069714652-11"><span class="crayon-h">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f54e069714652-12"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-e">insert_item</span><span class="crayon-sy">(</span><span class="crayon-v">item</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0018 seconds] -->
<p>定义好管道之后我们需要配置到爬虫上，我们在<code>settings.py</code>模块中配置，后面的数字表示管道的顺序</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f551079768220" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
ITEM_PIPELINES = {
    'pipelines.DuplicatesPipeline.DuplicatesPipeline': 1,
    'pipelines.PretreatmentPipeline.PretreatmentPipeline': 2,
}</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f551079768220-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f551079768220-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f551079768220-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f551079768220-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f551079768220-1"><span class="crayon-v">ITEM_PIPELINES</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f551079768220-2"><span class="crayon-h">    </span><span class="crayon-s">'pipelines.DuplicatesPipeline.DuplicatesPipeline'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f551079768220-3"><span class="crayon-h">    </span><span class="crayon-s">'pipelines.PretreatmentPipeline.PretreatmentPipeline'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f551079768220-4"><span class="crayon-sy">}</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>我们也可以为spider配置单独的pipeline</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f555145412067" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
class TestSpider(Spider):
    # 自定义配置
    custom_settings = {
        # item处理管道
        'ITEM_PIPELINES': {
            'tutorial.pipelines.FangDetailPipeline.FangDetailPipeline': 1,
        },
    }
    ...</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f555145412067-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f555145412067-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f555145412067-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f555145412067-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f555145412067-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f555145412067-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f555145412067-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f555145412067-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f555145412067-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f555145412067-1"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">TestSpider</span><span class="crayon-sy">(</span><span class="crayon-v">Spider</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f555145412067-2"><span class="crayon-h">    </span><span class="crayon-p"># 自定义配置</span></div><div class="crayon-line" id="crayon-598cd7d19f555145412067-3"><span class="crayon-h">    </span><span class="crayon-v">custom_settings</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f555145412067-4"><span class="crayon-h">        </span><span class="crayon-p"># item处理管道</span></div><div class="crayon-line" id="crayon-598cd7d19f555145412067-5"><span class="crayon-h">        </span><span class="crayon-s">'ITEM_PIPELINES'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f555145412067-6"><span class="crayon-h">            </span><span class="crayon-s">'tutorial.pipelines.FangDetailPipeline.FangDetailPipeline'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f555145412067-7"><span class="crayon-h">        </span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f555145412067-8"><span class="crayon-h">    </span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-598cd7d19f555145412067-9"><span class="crayon-h">    </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>除了<code>process_item</code>方法外，pipeline还有<code>open_spider</code>和<code>spider_closed</code>两个方法，在爬虫启动和关闭的时候调用</p>
<h2>七、Rule</h2>
<p>爬虫的通常需要在一个网页里面爬去其他的链接，然后一层一层往下爬，scrapy提供了LinkExtractor类用于对网页链接的提取，使用LinkExtractor需要使用<code>CrawlSpider</code>爬虫类中，<code>CrawlSpider</code>与<code>Spider</code>相比主要是多了<code>rules</code>，可以添加一些规则，先看下面这个例子，爬取链家网的链接</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f558122729617" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div><span class="crayon-language">Python</span></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
from scrapy.spiders import CrawlSpider, Rule
from scrapy.linkextractors import LinkExtractor

class LianjiaSpider(CrawlSpider):
    name = "lianjia"

    allowed_domains = ["lianjia.com"]

    start_urls = [
        "http://bj.lianjia.com/ershoufang/"
    ]

    rules = [
        # 匹配正则表达式,处理下一页
        Rule(LinkExtractor(allow=(r'http://bj.lianjia.com/ershoufang/pg\s+$',)), callback='parse_item'),

        # 匹配正则表达式,结果加到url列表中,设置请求预处理函数
        # Rule(FangLinkExtractor(allow=('http://www.lianjia.com/client/', )), follow=True, process_request='add_cookie')
    ]

    def parse_item(self, response):
        # 这里与之前的parse方法一样，处理
        pass</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-14">14</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-16">16</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-18">18</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-20">20</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f558122729617-22">22</div><div class="crayon-num" data-line="crayon-598cd7d19f558122729617-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f558122729617-1"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-e">spiders </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-v">CrawlSpider</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">Rule</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-2"><span class="crayon-st">from</span><span class="crayon-h"> </span><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-e">linkextractors </span><span class="crayon-r">import</span><span class="crayon-h"> </span><span class="crayon-e">LinkExtractor</span></div><div class="crayon-line" id="crayon-598cd7d19f558122729617-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-4"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">LianjiaSpider</span><span class="crayon-sy">(</span><span class="crayon-v">CrawlSpider</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f558122729617-5"><span class="crayon-h">    </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"lianjia"</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-6"> </div><div class="crayon-line" id="crayon-598cd7d19f558122729617-7"><span class="crayon-h">    </span><span class="crayon-v">allowed_domains</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">"lianjia.com"</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-8"> </div><div class="crayon-line" id="crayon-598cd7d19f558122729617-9"><span class="crayon-h">    </span><span class="crayon-v">start_urls</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-10"><span class="crayon-h">        </span><span class="crayon-s">"http://bj.lianjia.com/ershoufang/"</span></div><div class="crayon-line" id="crayon-598cd7d19f558122729617-11"><span class="crayon-h">    </span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-12"> </div><div class="crayon-line" id="crayon-598cd7d19f558122729617-13"><span class="crayon-h">    </span><span class="crayon-v">rules</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-14"><span class="crayon-h">        </span><span class="crayon-c"># 匹配正则表达式,处理下一页</span></div><div class="crayon-line" id="crayon-598cd7d19f558122729617-15"><span class="crayon-h">        </span><span class="crayon-e">Rule</span><span class="crayon-sy">(</span><span class="crayon-e">LinkExtractor</span><span class="crayon-sy">(</span><span class="crayon-v">allow</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-i">r</span><span class="crayon-s">'http://bj.lianjia.com/ershoufang/pg\s+$'</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">callback</span><span class="crayon-o">=</span><span class="crayon-s">'parse_item'</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-16"> </div><div class="crayon-line" id="crayon-598cd7d19f558122729617-17"><span class="crayon-h">        </span><span class="crayon-c"># 匹配正则表达式,结果加到url列表中,设置请求预处理函数</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-18"><span class="crayon-h">        </span><span class="crayon-c"># Rule(FangLinkExtractor(allow=('http://www.lianjia.com/client/', )), follow=True, process_request='add_cookie')</span></div><div class="crayon-line" id="crayon-598cd7d19f558122729617-19"><span class="crayon-h">    </span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-20"> </div><div class="crayon-line" id="crayon-598cd7d19f558122729617-21"><span class="crayon-h">    </span><span class="crayon-r">def</span><span class="crayon-h"> </span><span class="crayon-e">parse_item</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f558122729617-22"><span class="crayon-h">        </span><span class="crayon-c"># 这里与之前的parse方法一样，处理</span></div><div class="crayon-line" id="crayon-598cd7d19f558122729617-23"><span class="crayon-h">        </span><span class="crayon-r">pass</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0029 seconds] -->
<p></p>
<h3>1. Rule对象</h3>
<p>Role对象有下面参数</p>
<ul>
<li><code>link_extractor</code>：链接提取规则</li>
<li><code>callback</code>：link_extractor提取的链接的请求结果的回调</li>
<li><code>cb_kwargs</code>：附加参数，可以在回调函数中获取到</li>
<li><code>follow</code>：表示提取的链接请求完成后是否还要应用当前规则（boolean），如果为<code>False</code>则不会对提取出来的网页进行进一步提取，默认为False</li>
<li><code>process_links</code>：处理所有的链接的回调，用于处理从response提取的links，通常用于过滤（参数为link列表）</li>
<li><code>process_request</code>：链接请求预处理（添加header或cookie等）</li>
</ul>
<h3>2. LinkExtractor</h3>
<p>LinkExtractor常用的参数有：</p>
<ul>
<li><code>allow</code>：提取满足正则表达式的链接</li>
<li><code>deny</code>：排除正则表达式匹配的链接（优先级高于<code>allow</code>）</li>
<li><code>allow_domains</code>：允许的域名（可以是<code>str</code>或<code>list</code>）</li>
<li><code>deny_domains</code>：排除的域名（可以是<code>str</code>或<code>list</code>）</li>
<li><code>restrict_xpaths</code>：提取满足XPath选择条件的链接（可以是<code>str</code>或<code>list</code>）</li>
<li><code>restrict_css</code>：提取满足css选择条件的链接（可以是<code>str</code>或<code>list</code>）</li>
<li><code>tags</code>：提取指定标签下的链接，默认从<code>a</code>和<code>area</code>中提取（可以是<code>str</code>或<code>list</code>）</li>
<li><code>attrs</code>：提取满足拥有属性的链接，默认为<code>href</code>（类型为<code>list</code>）</li>
<li><code>unique</code>：链接是否去重（类型为<code>boolean</code>）</li>
<li><code>process_value</code>：值处理函数（优先级大于<code>allow</code>）</li>
</ul>
<p>关于LinkExtractor的详细参数介绍见<a href="http://doc.scrapy.org/en/latest/topics/link-extractors.html#module-scrapy.linkextractors.lxmlhtml">官网</a></p>
<blockquote><p>注意：如果使用rules规则，请不要覆盖或重写<code>CrawlSpider</code>的<code>parse</code>方法，否则规则会失效，可以使用<code>parse_start_urls</code>方法</p></blockquote>
<h2>八、Middleware</h2>
<p>从最开始的流程图可以看到，爬去一个资源链接的流程，首先我们配置spider相关的爬取信息，在启动爬取实例后，<code>scrapy_engine</code>从Spider取出<code>Request</code>（经过<code>SpiderMiddleware</code>），然后丢给Scheduler（经过<code>SchedulerMiddleware</code>），Scheduler接着把请求丢给Downloader（经过<code>DownloadMiddlware</code>），Downloader把请求结果丢还给Spider，然后Spider把分析好的结构化数据丢给Pipeline，Pipeline进行分析保存或丢弃，这里面有4个角色</p>
<p>scrapy有下面三种middlewares</p>
<ul>
<li><code>SpiderMiddleware</code>：通常用于配置爬虫相关的属性，引用链接设置，Url长度限制，成功状态码设置，爬取深度设置，爬去优先级设置等</li>
<li><code>DownloadMiddlware</code>：通常用于处理下载之前的预处理，如请求Header（Cookie,User-Agent），登录验证处理，重定向处理，代理服务器处理，超时处理，重试处理等</li>
<li><code>SchedulerMiddleware</code>（已经废弃）：为了简化框架，调度器中间件已经被废弃，使用另外两个中间件已经够用了</li>
</ul>
<h3>1. SpiderMiddleware</h3>
<p>爬虫中间件有下面几个方法</p>
<ul>
<li><code>process_spider_input</code>：当response通过spider的时候被调用，返回None（继续给其他中间件处理）或抛出异常（不会给其他中间件处理，当成异常处理）</li>
<li><code>process_spider_output</code>：当spider有item或Request输出的时候调动</li>
<li><code>process_spider_exception</code>：处理出现异常时调用</li>
<li><code>process_start_requests</code>：spider当开始请求Request的时候调用</li>
</ul>
<p>下面是scrapy自带的一些中间件（在<code>scrapy.spidermiddlewares</code>命名空间下）</p>
<ul>
<li>UrlLengthMiddleware</li>
<li>RefererMiddleware</li>
<li>OffsiteMiddleware</li>
<li>HttpErrorMiddleware</li>
<li>DepthMiddleware</li>
</ul>
<p>我们自己实现一个<code>SpiderMiddleware</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f55f304725208" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
TODO</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f55f304725208-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f55f304725208-1"><span class="crayon-v">TODO</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<blockquote><p>参考链接：<a href="http://doc.scrapy.org/en/latest/topics/spider-middleware.html">http://doc.scrapy.org/en/latest/topics/spider-middleware.html</a></p></blockquote>
<h3>2. DownloaderMiddleware</h3>
<p>下载中间件有下面几个方法</p>
<ul>
<li><code>process_request</code>：请求通过下载器的时候调用</li>
<li><code>process_response</code>：请求完成后调用</li>
<li><code>process_exception</code>：请求发生异常时调用</li>
<li><code>from_crawler</code>：从crawler构造的时候调用</li>
<li><code>from_settings</code>：从settings构造的时候调用</li>
<li><code></code></li>
</ul>
<blockquote><p>更多详细的参数解释见<a href="https://scrapy-chs.readthedocs.io/zh_CN/0.24/topics/downloader-middleware.html#id2">这里</a></p></blockquote>
<p>在爬取网页的时候，使用不同的<code>User-Agent</code>可以提高请求的随机性，定义一个随机设置User-Agent的中间件<code>RandomUserAgentMiddleware</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f562197129608" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
import random

class RandomUserAgentMiddleware(object):
    """Randomly rotate user agents based on a list of predefined ones"""

    def __init__(self, agents):
        self.agents = agents

    # 从crawler构造，USER_AGENTS定义在crawler的配置的设置中
    @classmethod
    def from_crawler(cls, crawler):
        return cls(crawler.settings.getlist('USER_AGENTS'))

    # 从settings构造，USER_AGENTS定义在settings.py中
    @classmethod
    def from_settings(cls, settings):
        return cls(settings.getlist('USER_AGENTS'))

    def process_request(self, request, spider):
        # 设置随机的User-Agent
        request.headers.setdefault('User-Agent', random.choice(self.agents))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f562197129608-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f562197129608-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f562197129608-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f562197129608-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f562197129608-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f562197129608-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f562197129608-14">14</div><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f562197129608-16">16</div><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f562197129608-18">18</div><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f562197129608-20">20</div><div class="crayon-num" data-line="crayon-598cd7d19f562197129608-21">21</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f562197129608-1"><span class="crayon-e">import </span><span class="crayon-e">random</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f562197129608-2"> </div><div class="crayon-line" id="crayon-598cd7d19f562197129608-3"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">RandomUserAgentMiddleware</span><span class="crayon-sy">(</span><span class="crayon-t">object</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f562197129608-4"><span class="crayon-h">    </span><span class="crayon-s">""</span><span class="crayon-s">"Randomly rotate user agents based on a list of predefined ones"</span><span class="crayon-s">""</span></div><div class="crayon-line" id="crayon-598cd7d19f562197129608-5"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f562197129608-6"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">agents</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f562197129608-7"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">agents</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">agents</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f562197129608-8"> </div><div class="crayon-line" id="crayon-598cd7d19f562197129608-9"><span class="crayon-h">    </span><span class="crayon-p"># 从crawler构造，USER_AGENTS定义在crawler的配置的设置中</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f562197129608-10"><span class="crayon-h">    </span><span class="crayon-sy">@</span><span class="crayon-e">classmethod</span></div><div class="crayon-line" id="crayon-598cd7d19f562197129608-11"><span class="crayon-e">    </span><span class="crayon-e">def </span><span class="crayon-e">from_crawler</span><span class="crayon-sy">(</span><span class="crayon-v">cls</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">crawler</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f562197129608-12"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">cls</span><span class="crayon-sy">(</span><span class="crayon-v">crawler</span><span class="crayon-sy">.</span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-e">getlist</span><span class="crayon-sy">(</span><span class="crayon-s">'USER_AGENTS'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f562197129608-13"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f562197129608-14"><span class="crayon-h">    </span><span class="crayon-p"># 从settings构造，USER_AGENTS定义在settings.py中</span></div><div class="crayon-line" id="crayon-598cd7d19f562197129608-15"><span class="crayon-h">    </span><span class="crayon-sy">@</span><span class="crayon-e">classmethod</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f562197129608-16"><span class="crayon-e">    </span><span class="crayon-e">def </span><span class="crayon-e">from_settings</span><span class="crayon-sy">(</span><span class="crayon-v">cls</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">settings</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f562197129608-17"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">cls</span><span class="crayon-sy">(</span><span class="crayon-v">settings</span><span class="crayon-sy">.</span><span class="crayon-e">getlist</span><span class="crayon-sy">(</span><span class="crayon-s">'USER_AGENTS'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f562197129608-18"> </div><div class="crayon-line" id="crayon-598cd7d19f562197129608-19"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">process_request</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">spider</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f562197129608-20"><span class="crayon-h">        </span><span class="crayon-p"># 设置随机的User-Agent</span></div><div class="crayon-line" id="crayon-598cd7d19f562197129608-21"><span class="crayon-h">        </span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">headers</span><span class="crayon-sy">.</span><span class="crayon-e">setdefault</span><span class="crayon-sy">(</span><span class="crayon-s">'User-Agent'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">random</span><span class="crayon-sy">.</span><span class="crayon-e">choice</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">agents</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0027 seconds] -->
<p>在<code>settings.py</code>设置USER_AGENTS参数</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f566922293649" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
USER_AGENTS = [
    "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; AcooBrowser; .NET CLR 1.1.4322; .NET CLR 2.0.50727)",
    "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; Acoo Browser; SLCC1; .NET CLR 2.0.50727; Media Center PC 5.0; .NET CLR 3.0.04506)",
    "Mozilla/4.0 (compatible; MSIE 7.0; AOL 9.5; AOLBuild 4337.35; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)",
    "Mozilla/5.0 (Windows; U; MSIE 9.0; Windows NT 9.0; en-US)",
    "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 2.0.50727; Media Center PC 6.0)",
    "Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0; WOW64; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 1.0.3705; .NET CLR 1.1.4322)",
    "Mozilla/4.0 (compatible; MSIE 7.0b; Windows NT 5.2; .NET CLR 1.1.4322; .NET CLR 2.0.50727; InfoPath.2; .NET CLR 3.0.04506.30)",
    "Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN) AppleWebKit/523.15 (KHTML, like Gecko, Safari/419.3) Arora/0.3 (Change: 287 c9dfb30)",
    "Mozilla/5.0 (X11; U; Linux; en-US) AppleWebKit/527+ (KHTML, like Gecko, Safari/419.3) Arora/0.6",
    "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.2pre) Gecko/20070215 K-Ninja/2.1.1",
    "Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9) Gecko/20080705 Firefox/3.0 Kapiko/3.0",
    "Mozilla/5.0 (X11; Linux i686; U;) Gecko/20070322 Kazehakase/0.4.5",
    "Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko Fedora/1.9.0.8-1.fc10 Kazehakase/0.5.6",
    "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.56 Safari/535.11",
    "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_3) AppleWebKit/535.20 (KHTML, like Gecko) Chrome/19.0.1036.7 Safari/535.20",
    "Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; fr) Presto/2.9.168 Version/11.52",
]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f566922293649-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f566922293649-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f566922293649-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f566922293649-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f566922293649-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f566922293649-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f566922293649-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f566922293649-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f566922293649-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f566922293649-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f566922293649-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f566922293649-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f566922293649-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f566922293649-14">14</div><div class="crayon-num" data-line="crayon-598cd7d19f566922293649-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f566922293649-16">16</div><div class="crayon-num" data-line="crayon-598cd7d19f566922293649-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f566922293649-18">18</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f566922293649-1"><span class="crayon-v">USER_AGENTS</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f566922293649-2"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; AcooBrowser; .NET CLR 1.1.4322; .NET CLR 2.0.50727)"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f566922293649-3"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; Acoo Browser; SLCC1; .NET CLR 2.0.50727; Media Center PC 5.0; .NET CLR 3.0.04506)"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f566922293649-4"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/4.0 (compatible; MSIE 7.0; AOL 9.5; AOLBuild 4337.35; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f566922293649-5"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (Windows; U; MSIE 9.0; Windows NT 9.0; en-US)"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f566922293649-6"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 2.0.50727; Media Center PC 6.0)"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f566922293649-7"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0; WOW64; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 1.0.3705; .NET CLR 1.1.4322)"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f566922293649-8"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/4.0 (compatible; MSIE 7.0b; Windows NT 5.2; .NET CLR 1.1.4322; .NET CLR 2.0.50727; InfoPath.2; .NET CLR 3.0.04506.30)"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f566922293649-9"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN) AppleWebKit/523.15 (KHTML, like Gecko, Safari/419.3) Arora/0.3 (Change: 287 c9dfb30)"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f566922293649-10"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (X11; U; Linux; en-US) AppleWebKit/527+ (KHTML, like Gecko, Safari/419.3) Arora/0.6"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f566922293649-11"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.2pre) Gecko/20070215 K-Ninja/2.1.1"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f566922293649-12"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9) Gecko/20080705 Firefox/3.0 Kapiko/3.0"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f566922293649-13"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (X11; Linux i686; U;) Gecko/20070322 Kazehakase/0.4.5"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f566922293649-14"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko Fedora/1.9.0.8-1.fc10 Kazehakase/0.5.6"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f566922293649-15"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.56 Safari/535.11"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f566922293649-16"><span class="crayon-h">    </span><span class="crayon-s">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_3) AppleWebKit/535.20 (KHTML, like Gecko) Chrome/19.0.1036.7 Safari/535.20"</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f566922293649-17"><span class="crayon-h">    </span><span class="crayon-s">"Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; fr) Presto/2.9.168 Version/11.52"</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f566922293649-18"><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0020 seconds] -->
<p>配置爬虫中间件的方式与pipeline类似，第二个参数表示优先级</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f574013747814" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
# 配置爬虫中间件
SPIDER_MIDDLEWARES = {
    'myproject.middlewares.CustomSpiderMiddleware': 543,
    # 如果想禁用默认的中间件的话，可以设置其优先级为None
    'scrapy.spidermiddlewares.offsite.OffsiteMiddleware': None,
}

# 配置下载中间件
DOWNLOADER_MIDDLEWARES = {
    'myproject.middlewares.RandomUserAgentMiddleware': 543,
    'scrapy.contrib.downloadermiddleware.useragent.UserAgentMiddleware': None,
}</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f574013747814-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f574013747814-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f574013747814-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f574013747814-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f574013747814-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f574013747814-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f574013747814-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f574013747814-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f574013747814-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f574013747814-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f574013747814-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f574013747814-12">12</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f574013747814-1"><span class="crayon-p"># 配置爬虫中间件</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f574013747814-2"><span class="crayon-v">SPIDER_MIDDLEWARES</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-598cd7d19f574013747814-3"><span class="crayon-h">    </span><span class="crayon-s">'myproject.middlewares.CustomSpiderMiddleware'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">543</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f574013747814-4"><span class="crayon-h">    </span><span class="crayon-p"># 如果想禁用默认的中间件的话，可以设置其优先级为None</span></div><div class="crayon-line" id="crayon-598cd7d19f574013747814-5"><span class="crayon-h">    </span><span class="crayon-s">'scrapy.spidermiddlewares.offsite.OffsiteMiddleware'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f574013747814-6"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-598cd7d19f574013747814-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f574013747814-8"><span class="crayon-p"># 配置下载中间件</span></div><div class="crayon-line" id="crayon-598cd7d19f574013747814-9"><span class="crayon-v">DOWNLOADER_MIDDLEWARES</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f574013747814-10"><span class="crayon-h">    </span><span class="crayon-s">'myproject.middlewares.RandomUserAgentMiddleware'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">543</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f574013747814-11"><span class="crayon-h">    </span><span class="crayon-s">'scrapy.contrib.downloadermiddleware.useragent.UserAgentMiddleware'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f574013747814-12"><span class="crayon-sy">}</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0012 seconds] -->
<p></p>
<h2>九、缓存</h2>
<p>scrapy默认已经自带了缓存的功能，通常我们只需要配置即可，打开<code>settings.py</code></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f578186260001" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
# 打开缓存
HTTPCACHE_ENABLED = True

# 设置缓存过期时间（单位：秒）
#HTTPCACHE_EXPIRATION_SECS = 0

# 缓存路径(默认为：.scrapy/httpcache)
HTTPCACHE_DIR = 'httpcache'

# 忽略的状态码
HTTPCACHE_IGNORE_HTTP_CODES = []

# 缓存模式(文件缓存)
HTTPCACHE_STORAGE = 'scrapy.extensions.httpcache.FilesystemCacheStorage'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f578186260001-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f578186260001-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f578186260001-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f578186260001-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f578186260001-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f578186260001-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f578186260001-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f578186260001-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f578186260001-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f578186260001-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f578186260001-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f578186260001-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f578186260001-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f578186260001-14">14</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f578186260001-1"><span class="crayon-p"># 打开缓存</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f578186260001-2"><span class="crayon-v">HTTPCACHE_ENABLED</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span></div><div class="crayon-line" id="crayon-598cd7d19f578186260001-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f578186260001-4"><span class="crayon-p"># 设置缓存过期时间（单位：秒）</span></div><div class="crayon-line" id="crayon-598cd7d19f578186260001-5"><span class="crayon-p">#HTTPCACHE_EXPIRATION_SECS = 0</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f578186260001-6"> </div><div class="crayon-line" id="crayon-598cd7d19f578186260001-7"><span class="crayon-p"># 缓存路径(默认为：.scrapy/httpcache)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f578186260001-8"><span class="crayon-v">HTTPCACHE_DIR</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'httpcache'</span></div><div class="crayon-line" id="crayon-598cd7d19f578186260001-9"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f578186260001-10"><span class="crayon-p"># 忽略的状态码</span></div><div class="crayon-line" id="crayon-598cd7d19f578186260001-11"><span class="crayon-v">HTTPCACHE_IGNORE_HTTP_CODES</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f578186260001-12"> </div><div class="crayon-line" id="crayon-598cd7d19f578186260001-13"><span class="crayon-p"># 缓存模式(文件缓存)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f578186260001-14"><span class="crayon-v">HTTPCACHE_STORAGE</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'scrapy.extensions.httpcache.FilesystemCacheStorage'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0009 seconds] -->
<p></p>
<blockquote><p>更多参数参见<a href="http://scrapy.readthedocs.org/en/latest/topics/downloader-middleware.html#httpcache-middleware-settings">这里</a></p></blockquote>
<h2>十、多线程</h2>
<p>scrapy网络请求是基于Twisted，而Twisted默认支持多线程，而且scrapy默认也是通过多线程请求的，并且支持多核CPU的并发，通常只需要配置一些参数即可</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f57c595600735" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
# 默认Item并发数：100
CONCURRENT_ITEMS = 100

# 默认Request并发数：16
CONCURRENT_REQUESTS = 16

# 默认每个域名的并发数：8
CONCURRENT_REQUESTS_PER_DOMAIN = 8

# 每个IP的最大并发数：0表示忽略
CONCURRENT_REQUESTS_PER_IP = 0</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f57c595600735-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f57c595600735-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f57c595600735-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f57c595600735-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f57c595600735-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f57c595600735-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f57c595600735-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f57c595600735-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f57c595600735-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f57c595600735-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f57c595600735-11">11</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f57c595600735-1"><span class="crayon-p"># 默认Item并发数：100</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f57c595600735-2"><span class="crayon-v">CONCURRENT_ITEMS</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span></div><div class="crayon-line" id="crayon-598cd7d19f57c595600735-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f57c595600735-4"><span class="crayon-p"># 默认Request并发数：16</span></div><div class="crayon-line" id="crayon-598cd7d19f57c595600735-5"><span class="crayon-v">CONCURRENT_REQUESTS</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">16</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f57c595600735-6"> </div><div class="crayon-line" id="crayon-598cd7d19f57c595600735-7"><span class="crayon-p"># 默认每个域名的并发数：8</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f57c595600735-8"><span class="crayon-v">CONCURRENT_REQUESTS_PER_DOMAIN</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">8</span></div><div class="crayon-line" id="crayon-598cd7d19f57c595600735-9"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f57c595600735-10"><span class="crayon-p"># 每个IP的最大并发数：0表示忽略</span></div><div class="crayon-line" id="crayon-598cd7d19f57c595600735-11"><span class="crayon-v">CONCURRENT_REQUESTS_PER_IP</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0008 seconds] -->
<p></p>
<blockquote><p>更多参数参见<a href="https://doc.scrapy.org/en/latest/topics/settings.html#concurrent-items">这里</a></p></blockquote>
<h2>十一、常见问题</h2>
<h3>1. 项目名称问题</h3>
<p>在使用的时候遇到过一个问题，在初始化<code>scrapy startproject tutorial</code>的时候，如果使用了一些特殊的名字，如：<code>test</code>, <code>fang</code>等单词的话，通过<code>get_project_settings</code>方法获取配置的时候会出错，改成<code>tutorial</code>或一些复杂的名字的时候不会</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f57f554209619" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
ImportError: No module named tutorial.settings</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f57f554209619-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f57f554209619-1"><span class="crayon-v">ImportError</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">No </span><span class="crayon-e">module </span><span class="crayon-e">named </span><span class="crayon-v">tutorial</span><span class="crayon-sy">.</span><span class="crayon-v">settings</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>这是一个bug，在github上有提到：<a href="https://github.com/scrapy/scrapy/issues/428">https://github.com/scrapy/scrapy/issues/428</a>，但貌似没有完全修复，修改一下名字就好了（当然<code>scrapy.cfg</code>和<code>settings.py</code>里面也需要修改）</p>
<h3>2. 为每个pipeline配置spider</h3>
<p>上面我们是在settings.py里面配置pipeline，这里的配置的pipeline会作用于所有的spider，我们可以为每一个spider配置不同的pipeline，设置<code>Spider</code>的<code>custom_settings</code>对象</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f583736032120" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
class LianjiaSpider(CrawlSpider):
    ...
    # 自定义配置
    custom_settings = {
        'ITEM_PIPELINES': {
            'tutorial.pipelines.TestPipeline.TestPipeline': 1,
        }
    }</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f583736032120-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f583736032120-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f583736032120-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f583736032120-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f583736032120-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f583736032120-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f583736032120-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f583736032120-8">8</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f583736032120-1"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">LianjiaSpider</span><span class="crayon-sy">(</span><span class="crayon-v">CrawlSpider</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f583736032120-2"><span class="crayon-h">    </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-598cd7d19f583736032120-3"><span class="crayon-h">    </span><span class="crayon-p"># 自定义配置</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f583736032120-4"><span class="crayon-h">    </span><span class="crayon-v">custom_settings</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-598cd7d19f583736032120-5"><span class="crayon-h">        </span><span class="crayon-s">'ITEM_PIPELINES'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f583736032120-6"><span class="crayon-h">            </span><span class="crayon-s">'tutorial.pipelines.TestPipeline.TestPipeline'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-598cd7d19f583736032120-7"><span class="crayon-h">        </span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f583736032120-8"><span class="crayon-h">    </span><span class="crayon-sy">}</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0010 seconds] -->
<p></p>
<h3>3. 获取提取链接的节点信息</h3>
<p>通过LinkExtractor提取的<code>scrapy.Link</code>默认不带节点信息，有时候我们需要节点的其他attribute属性，<code>scrapy.Link</code>有个<code>text</code>属性保存从节点提取的<code>text</code>值，我们可以通过修改<code>lxmlhtml._collect_string_content</code>变量为<code>etree.tostring</code>，这样可以在提取节点值就变味渲染节点<code>scrapy.Link.text</code>，然后根据<code>scrapy.Link.text</code>属性拿到节点的html，最后提取出我们需要的值</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f586351129722" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
from lxml import etree
import scrapy.linkextractors.lxmlhtml
scrapy.linkextractors.lxmlhtml._collect_string_content = etree.tostring</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f586351129722-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f586351129722-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f586351129722-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f586351129722-1"><span class="crayon-e">from </span><span class="crayon-e">lxml </span><span class="crayon-e">import </span><span class="crayon-e">etree</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f586351129722-2"><span class="crayon-e">import </span><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-v">linkextractors</span><span class="crayon-sy">.</span><span class="crayon-e">lxmlhtml</span></div><div class="crayon-line" id="crayon-598cd7d19f586351129722-3"><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-v">linkextractors</span><span class="crayon-sy">.</span><span class="crayon-v">lxmlhtml</span><span class="crayon-sy">.</span><span class="crayon-v">_collect_string_content</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">etree</span><span class="crayon-sy">.</span><span class="crayon-v">tostring</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0008 seconds] -->
<p></p>
<h3>4. 从数据库中读取urls</h3>
<p>有时候我们已经把urls下载到数据库了，而不是在start_urls里配置，这时候可以重载spider的<code>start_requests</code>方法</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f589258715032" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
def start_requests(self):
    for u in self.db.session.query(User.link):
        yield Request(u.link)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f589258715032-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f589258715032-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f589258715032-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f589258715032-1"><span class="crayon-e">def </span><span class="crayon-e">start_requests</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f589258715032-2"><span class="crayon-h">    </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">u</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-v">session</span><span class="crayon-sy">.</span><span class="crayon-e">query</span><span class="crayon-sy">(</span><span class="crayon-v">User</span><span class="crayon-sy">.</span><span class="crayon-v">link</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f589258715032-3"><span class="crayon-h">        </span><span class="crayon-e">yield </span><span class="crayon-e">Request</span><span class="crayon-sy">(</span><span class="crayon-v">u</span><span class="crayon-sy">.</span><span class="crayon-v">link</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>我们还可以在Request添加元数据，然后在response中访问</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f58d117292262" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
def start_requests(self):
    for u in self.db.session.query(User):
        yield Request(u.link, meta={'name': u.name})

def parse(self, response):
    print response.url, response.meta['name']</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f58d117292262-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f58d117292262-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f58d117292262-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f58d117292262-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f58d117292262-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f58d117292262-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f58d117292262-1"><span class="crayon-e">def </span><span class="crayon-e">start_requests</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f58d117292262-2"><span class="crayon-h">    </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">u</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">db</span><span class="crayon-sy">.</span><span class="crayon-v">session</span><span class="crayon-sy">.</span><span class="crayon-e">query</span><span class="crayon-sy">(</span><span class="crayon-v">User</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f58d117292262-3"><span class="crayon-h">        </span><span class="crayon-e">yield </span><span class="crayon-e">Request</span><span class="crayon-sy">(</span><span class="crayon-v">u</span><span class="crayon-sy">.</span><span class="crayon-v">link</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">meta</span><span class="crayon-o">=</span><span class="crayon-sy">{</span><span class="crayon-s">'name'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">u</span><span class="crayon-sy">.</span><span class="crayon-v">name</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f58d117292262-4"> </div><div class="crayon-line" id="crayon-598cd7d19f58d117292262-5"><span class="crayon-e">def </span><span class="crayon-e">parse</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f58d117292262-6"><span class="crayon-h">    </span><span class="crayon-e">print </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">url</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">response</span><span class="crayon-sy">.</span><span class="crayon-v">meta</span><span class="crayon-sy">[</span><span class="crayon-s">'name'</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0015 seconds] -->
<p></p>
<h3>5. 如何进行循环爬取</h3>
<p>有时候我们需要爬取的一些经常更新的页面，例如：间隔时间为2s，爬去一个列表前10页的数据，从第一页开始爬，爬完成后重新回到第一页</p>
<p>目前的思路是，通过parse方法迭代返回Request进行增量爬取，由于scrapy默认由缓存机制，需要修改</p>
<h3>6. 关于去重</h3>
<p>scrapy默认有自己的去重机制，默认使用<code>scrapy.dupefilters.RFPDupeFilter</code>类进行去重，主要逻辑如下</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f590734022249" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
if include_headers:
    include_headers = tuple(to_bytes(h.lower())
                             for h in sorted(include_headers))
cache = _fingerprint_cache.setdefault(request, {})
if include_headers not in cache:
    fp = hashlib.sha1()
    fp.update(to_bytes(request.method))
    fp.update(to_bytes(canonicalize_url(request.url)))
    fp.update(request.body or b'')
    if include_headers:
        for hdr in include_headers:
            if hdr in request.headers:
                fp.update(hdr)
                for v in request.headers.getlist(hdr):
                    fp.update(v)
    cache[include_headers] = fp.hexdigest()
return cache[include_headers]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f590734022249-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f590734022249-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f590734022249-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f590734022249-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f590734022249-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f590734022249-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f590734022249-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f590734022249-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f590734022249-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f590734022249-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f590734022249-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f590734022249-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f590734022249-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f590734022249-14">14</div><div class="crayon-num" data-line="crayon-598cd7d19f590734022249-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f590734022249-16">16</div><div class="crayon-num" data-line="crayon-598cd7d19f590734022249-17">17</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f590734022249-1"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">include_headers</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f590734022249-2"><span class="crayon-h">    </span><span class="crayon-v">include_headers</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">tuple</span><span class="crayon-sy">(</span><span class="crayon-e">to_bytes</span><span class="crayon-sy">(</span><span class="crayon-v">h</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f590734022249-3"><span class="crayon-h">                             </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">h</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">sorted</span><span class="crayon-sy">(</span><span class="crayon-v">include_headers</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f590734022249-4"><span class="crayon-v">cache</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">_fingerprint_cache</span><span class="crayon-sy">.</span><span class="crayon-e">setdefault</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f590734022249-5"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">include_headers </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">cache</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f590734022249-6"><span class="crayon-h">    </span><span class="crayon-v">fp</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">hashlib</span><span class="crayon-sy">.</span><span class="crayon-e">sha1</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f590734022249-7"><span class="crayon-h">    </span><span class="crayon-v">fp</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-e">to_bytes</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">method</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f590734022249-8"><span class="crayon-h">    </span><span class="crayon-v">fp</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-e">to_bytes</span><span class="crayon-sy">(</span><span class="crayon-e">canonicalize_url</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">url</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f590734022249-9"><span class="crayon-h">    </span><span class="crayon-v">fp</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-e">body </span><span class="crayon-st">or</span><span class="crayon-h"> </span><span class="crayon-i">b</span><span class="crayon-s">''</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f590734022249-10"><span class="crayon-h">    </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">include_headers</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f590734022249-11"><span class="crayon-h">        </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">hdr </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">include_headers</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f590734022249-12"><span class="crayon-h">            </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">hdr </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">headers</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f590734022249-13"><span class="crayon-h">                </span><span class="crayon-v">fp</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">hdr</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f590734022249-14"><span class="crayon-h">                </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">v</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">headers</span><span class="crayon-sy">.</span><span class="crayon-e">getlist</span><span class="crayon-sy">(</span><span class="crayon-v">hdr</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f590734022249-15"><span class="crayon-h">                    </span><span class="crayon-v">fp</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">v</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f590734022249-16"><span class="crayon-h">    </span><span class="crayon-v">cache</span><span class="crayon-sy">[</span><span class="crayon-v">include_headers</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">fp</span><span class="crayon-sy">.</span><span class="crayon-e">hexdigest</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f590734022249-17"><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">cache</span><span class="crayon-sy">[</span><span class="crayon-v">include_headers</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0037 seconds] -->
<p>默认的去重指纹是sha1(method + url + body + header)，这种方式并不能过滤很多，例如有一些请求会加上时间戳的，基本每次都会不同，这时候我们需要自定义过滤规则</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f594217856834" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
from scrapy.dupefilter import RFPDupeFilter

class CustomURLFilter(RFPDupeFilter):
    """ 只根据url去重"""

    def __init__(self, path=None):
        self.urls_seen = set()
        RFPDupeFilter.__init__(self, path)

    def request_seen(self, request):
        if request.url in self.urls_seen:
            return True
        else:
            self.urls_seen.add(request.url)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f594217856834-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f594217856834-2">2</div><div class="crayon-num" data-line="crayon-598cd7d19f594217856834-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f594217856834-4">4</div><div class="crayon-num" data-line="crayon-598cd7d19f594217856834-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f594217856834-6">6</div><div class="crayon-num" data-line="crayon-598cd7d19f594217856834-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f594217856834-8">8</div><div class="crayon-num" data-line="crayon-598cd7d19f594217856834-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f594217856834-10">10</div><div class="crayon-num" data-line="crayon-598cd7d19f594217856834-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f594217856834-12">12</div><div class="crayon-num" data-line="crayon-598cd7d19f594217856834-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-598cd7d19f594217856834-14">14</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f594217856834-1"><span class="crayon-e">from </span><span class="crayon-v">scrapy</span><span class="crayon-sy">.</span><span class="crayon-e">dupefilter </span><span class="crayon-e">import </span><span class="crayon-e">RFPDupeFilter</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f594217856834-2"> </div><div class="crayon-line" id="crayon-598cd7d19f594217856834-3"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">CustomURLFilter</span><span class="crayon-sy">(</span><span class="crayon-v">RFPDupeFilter</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f594217856834-4"><span class="crayon-h">    </span><span class="crayon-s">""</span><span class="crayon-s">" 只根据url去重"</span><span class="crayon-s">""</span></div><div class="crayon-line" id="crayon-598cd7d19f594217856834-5"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f594217856834-6"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">path</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f594217856834-7"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">urls_seen</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f594217856834-8"><span class="crayon-h">        </span><span class="crayon-v">RFPDupeFilter</span><span class="crayon-sy">.</span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">path</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-598cd7d19f594217856834-9"> </div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f594217856834-10"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">request_seen</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-598cd7d19f594217856834-11"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-e">url </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">urls_seen</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f594217856834-12"><span class="crayon-h">            </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">True</span></div><div class="crayon-line" id="crayon-598cd7d19f594217856834-13"><span class="crayon-h">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-598cd7d19f594217856834-14"><span class="crayon-h">            </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">urls_seen</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">request</span><span class="crayon-sy">.</span><span class="crayon-v">url</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0021 seconds] -->
<p>配置setting</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->
<div class="crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-always" id="crayon-598cd7d19f597413689384" style=" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;"><div class="crayon-button crayon-nums-button" title="切换是否显示行编号"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="纯文本显示代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="切换自动换行"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="点击展开代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="复制代码"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="在新窗口中显示代码"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 18.2px !important; line-height: 18.2px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;" wrap="soft">
DUPEFILTER_CLASS = 'tutorial.custom_filters.CustomURLFilter'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 13px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-598cd7d19f597413689384-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-598cd7d19f597413689384-1"><span class="crayon-v">DUPEFILTER_CLASS</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'tutorial.custom_filters.CustomURLFilter'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p></p>
<h3>7. 如何在Pipeline中处理不同的Item</h3>
<p>scrapy所有的迭代出来的的Item都会经过所有的Pipeline，如果需要处理不同的Item，只能通过<code>isinstance()</code>方法进行类型判断，然后分别进行处理，暂时没有更好的方案</p>
<h3>8. url按顺序执行</h3>
<p>我们可以通过Request的priority控制url的请求的执行顺序，但由于网络请求的不确定性，不能保证返回也是按照顺序进行的，如果需要进行逐个url请求的话，吧url列表放在meta对象里面，在response的时候迭代返回下一个Request对象到调度器，达到顺序执行的目的，暂时没有更好的方案</p>
<h2>十二、总结</h2>
<p>scrapy虽然是最有名的python爬虫框架，但是还是有很多不足，例如，item不能单独配置给制定的pipeline，每一个爬取的所有item都会走遍所有的管道，需要在管道里面去判断不同类型的item，如果在pipelines和items比较多的项目，将会让项目变得非常臃肿</p>
<p>如有问题欢迎到<a href="http://blog.bomobox.org/2016-09-11/scrapy-start/">我的博客</a>留言</p>
<h2>十三、参考链接</h2>
<ul>
<li><a href="http://doc.scrapy.org/en/latest/index.html">官方文档</a></li>
<li><a href="https://scrapy-chs.readthedocs.org/zh_CN/0.24/intro/tutorial.html">中文教程</a></li>
<li><a href="https://segmentfault.com/a/1190000000533969">scrapy五大模块</a></li>
</ul>
</div>
<div class="post-adds">
<span class=" btn-bluet-bigger href-style vote-post-up register-user-only " data-post-id="86584"><i class="fa fa-thumbs-o-up"></i> <h10 id="86584votetotal">3</h10> 赞</span>
<span class=" btn-bluet-bigger href-style bookmark-btn register-user-only " data-book-type="1" data-item-id="86584" data-item-type="1" data-site-id="13"><i class="fa fa-bookmark-o "></i> 12 收藏</span>
<a href="#article-comment"><span class="btn-bluet-bigger href-style hide-on-480"><i class="fa fa-comments-o"></i> 5 评论</span></a>
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style_24x24" style="display: inline-flex; position: relative; margin: 0; clear: both;float: right;">
<a class="jiathis_button_tsina"></a>
<a class="jiathis_button_weixin"></a>
<a class="jiathis_button_qzone"></a>
<a class="jiathis_button_fb hide-on-480"></a>
<a class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" href="http://www.jiathis.com/share?uid=1745061" target="_blank"></a>
</div>
</div>
<!-- BEGIN #author-bio -->
<!-- END #author-bio -->
</div>
    
</body></html>
